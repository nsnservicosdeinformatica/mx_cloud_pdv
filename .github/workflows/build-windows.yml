name: Build Windows

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Flavor to build (mobile ou stoneP2)'
        required: false
        default: 'mobile'
        type: choice
        options:
          - mobile
          - stoneP2

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    env:
      FLAVOR: ${{ github.event.inputs.flavor || 'mobile' }}
      BUILD_MODE: ${{ github.ref == 'refs/heads/main' && 'release' || 'debug' }}
      BUILD_TYPE: ${{ github.ref == 'refs/heads/main' && 'Release' || 'Debug' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Create Windows platform files (if needed)
        run: flutter create --platforms=windows .

      - name: Prepare Windows build (remove stone_payments)
        run: |
          Write-Host "=========================================="
          Write-Host "PREPARING WINDOWS BUILD"
          Write-Host "REMOVING STONE_PAYMENTS PACKAGE"
          Write-Host "=========================================="
          Write-Host "   O pacote stone_payments n√£o tem suporte Windows"
          Write-Host "   Removendo do pubspec.yaml e criando stubs"
          Write-Host "   O pacote N√ÉO ser√° inclu√≠do no execut√°vel Windows"
          
          # Remove stone_payments do pubspec.yaml
          Copy-Item pubspec.yaml pubspec.yaml.bak
          Write-Host "   Backup criado: pubspec.yaml.bak"
          
          $content = Get-Content pubspec.yaml -Raw
          $content = $content -replace '\s*stone_payments:\s*[^\r\n]+[\r\n]*', ''
          $content = $content -replace '# Payment SDKs \(condicionais por flavor\)[\r\n]*', ''
          $content = $content -replace '# stone_payments: necess√°rio para compilar c√≥digo Dart[\r\n]*', ''
          $content = $content -replace '# As depend√™ncias nativas ser√£o exclu√≠das no build\.gradle\.kts para o flavor mobile[\r\n]*', ''
          $content = $content -replace "(\r?\n\s*){4,}", "`r`n`r`n`r`n"
          Set-Content -Path pubspec.yaml -Value $content -NoNewline
          Write-Host "‚úÖ stone_payments removido do pubspec.yaml"
          
          # Cria stubs dos arquivos que importam stone_payments
          Write-Host ""
          Write-Host "   Criando stubs dos arquivos que importam stone_payments..."
          
          # Stub para stone_pos_adapter.dart
          $stoneAdapterPath = "lib/data/adapters/payment/providers/stone_pos_adapter.dart"
          if (Test-Path $stoneAdapterPath) {
            Copy-Item $stoneAdapterPath "$stoneAdapterPath.bak"
            $stubLines = @(
              "// STUB: Este arquivo substitui stone_pos_adapter.dart quando stone_payments n√£o est√° dispon√≠vel (Windows)",
              "import '../../../../core/payment/payment_provider.dart';",
              "import '../../../../core/payment/payment_ui_notifier.dart';",
              "import 'package:flutter/foundation.dart';",
              "",
              "/// Stub do Stone POS Adapter (n√£o dispon√≠vel no Windows)",
              "class StonePOSAdapter implements PaymentProvider {",
              "  final Map<String, dynamic>? _settings;",
              "  ",
              "  StonePOSAdapter({Map<String, dynamic>? settings}) : _settings = settings;",
              "  ",
              "  @override",
              "  String get providerName => 'Stone';",
              "  ",
              "  @override",
              "  PaymentType get paymentType => PaymentType.pos;",
              "  ",
              "  @override",
              "  bool get isAvailable => false;",
              "  ",
              "  @override",
              "  bool get requiresUserInteraction => true;",
              "  ",
              "  @override",
              "  Future<void> initialize() async {",
              "    throw UnimplementedError('Stone POS Adapter n√£o dispon√≠vel no Windows');",
              "  }",
              "  ",
              "  @override",
              "  Future<PaymentResult> processPayment({",
              "    required double amount,",
              "    required String vendaId,",
              "    Map<String, dynamic>? additionalData,",
              "    PaymentUINotifier? uiNotifier,",
              "  }) async {",
              "    throw UnimplementedError('Stone POS Adapter n√£o dispon√≠vel no Windows');",
              "  }",
              "  ",
              "  @override",
              "  Future<void> disconnect() async {",
              "    // Nada a fazer",
              "  }",
              "}"
            )
            Set-Content -Path $stoneAdapterPath -Value ($stubLines -join "`r`n")
            Write-Host "   ‚úÖ Stub criado: $stoneAdapterPath"
          }
          
          # Stub para stone_thermal_adapter.dart
          $stoneThermalPath = "lib/data/adapters/printing/providers/stone_thermal_adapter.dart"
          if (Test-Path $stoneThermalPath) {
            Copy-Item $stoneThermalPath "$stoneThermalPath.bak"
            $stubLines = @(
              "// STUB: Este arquivo substitui stone_thermal_adapter.dart quando stone_payments n√£o est√° dispon√≠vel (Windows)",
              "import '../../../../core/printing/print_provider.dart';",
              "import '../../../../core/printing/print_data.dart';",
              "import '../../../../core/printing/nfce_print_data.dart';",
              "import 'package:flutter/foundation.dart';",
              "",
              "/// Stub do Stone Thermal Adapter (n√£o dispon√≠vel no Windows)",
              "class StoneThermalAdapter implements PrintProvider {",
              "  final Map<String, dynamic>? _settings;",
              "  bool _initialized = false;",
              "  ",
              "  StoneThermalAdapter({Map<String, dynamic>? settings}) : _settings = settings;",
              "  ",
              "  @override",
              "  String get providerName => 'Stone Thermal';",
              "  ",
              "  @override",
              "  PrintType get printType => PrintType.thermal;",
              "  ",
              "  @override",
              "  bool get isAvailable => false;",
              "  ",
              "  @override",
              "  Future<void> initialize() async {",
              "    throw UnimplementedError('Stone Thermal Adapter n√£o dispon√≠vel no Windows');",
              "  }",
              "  ",
              "  @override",
              "  Future<PrintResult> printComanda(PrintData data) async {",
              "    throw UnimplementedError('Stone Thermal Adapter n√£o dispon√≠vel no Windows');",
              "  }",
              "  ",
              "  @override",
              "  Future<PrintResult> printNfce(NfcePrintData data) async {",
              "    throw UnimplementedError('Stone Thermal Adapter n√£o dispon√≠vel no Windows');",
              "  }",
              "  ",
              "  @override",
              "  Future<bool> checkPrinterStatus() async {",
              "    throw UnimplementedError('Stone Thermal Adapter n√£o dispon√≠vel no Windows');",
              "  }",
              "  ",
              "  @override",
              "  Future<void> disconnect() async {",
              "    // Nada a fazer",
              "  }",
              "}"
            )
            Set-Content -Path $stoneThermalPath -Value ($stubLines -join "`r`n")
            Write-Host "   ‚úÖ Stub criado: $stoneThermalPath"
          }
          
          # Stub para stone_thermal_adapter_loader.dart
          $stoneThermalLoaderPath = "lib/data/adapters/printing/providers/stone_thermal_adapter_loader.dart"
          if (Test-Path $stoneThermalLoaderPath) {
            Copy-Item $stoneThermalLoaderPath "$stoneThermalLoaderPath.bak"
            $stubLines = @(
              "// STUB: Este arquivo substitui stone_thermal_adapter_loader.dart quando stone_payments n√£o est√° dispon√≠vel (Windows)",
              "import '../../../../core/printing/print_provider.dart';",
              "import 'stone_thermal_adapter.dart';",
              "",
              "/// Stub do loader do Stone Thermal Adapter (n√£o dispon√≠vel no Windows)",
              "PrintProvider Function(Map<String, dynamic>?) createStoneThermalAdapterLoader() {",
              "  return (settings) {",
              "    return StoneThermalAdapter(settings: settings);",
              "  };",
              "}"
            )
            Set-Content -Path $stoneThermalLoaderPath -Value ($stubLines -join "`r`n")
            Write-Host "   ‚úÖ Stub criado: $stoneThermalLoaderPath"
          }
          
          # Stub para stone_transaction_mapper.dart
          $stoneMapperPath = "lib/data/adapters/payment/providers/mappers/stone_transaction_mapper.dart"
          if (Test-Path $stoneMapperPath) {
            Copy-Item $stoneMapperPath "$stoneMapperPath.bak"
            $stubLines = @(
              "// STUB: Este arquivo substitui stone_transaction_mapper.dart quando stone_payments n√£o est√° dispon√≠vel (Windows)",
              "import '../../../../../core/payment/payment_transaction_data.dart';",
              "",
              "/// Stub do mapper de transa√ß√µes Stone (n√£o dispon√≠vel no Windows)",
              "class StoneTransactionMapper {",
              "  /// Stub - lan√ßa erro pois Stone SDK n√£o est√° dispon√≠vel no Windows",
              "  static PaymentTransactionData fromStoneTransaction(dynamic transaction) {",
              "    throw UnimplementedError('Stone Transaction Mapper n√£o dispon√≠vel no Windows');",
              "  }",
              "  ",
              "  /// Stub - lan√ßa erro pois Stone SDK n√£o est√° dispon√≠vel no Windows",
              "  static PaymentTransactionData fromStoneMetadata(Map<String, dynamic> metadata) {",
              "    throw UnimplementedError('Stone Transaction Mapper n√£o dispon√≠vel no Windows');",
              "  }",
              "}"
            )
            Set-Content -Path $stoneMapperPath -Value ($stubLines -join "`r`n")
            Write-Host "   ‚úÖ Stub criado: $stoneMapperPath"
          }
          
          # Stub para print_provider_registry.dart (remove import do loader)
          $printRegistryPath = "lib/data/adapters/printing/print_provider_registry.dart"
          if (Test-Path $printRegistryPath) {
            Copy-Item $printRegistryPath "$printRegistryPath.bak"
            $stubLines = @(
              "import '../../../../core/printing/print_provider.dart';",
              "import 'package:flutter/foundation.dart';",
              "import 'providers/elgin_thermal_adapter.dart';",
              "import 'providers/pdf_printer_adapter.dart';",
              "import '../../../../core/printing/print_config.dart';",
              "import '../../../../core/config/flavor_config.dart';",
              "",
              "/// Cria o adapter Stone Thermal - STUB para Windows (n√£o dispon√≠vel)",
              "PrintProvider _createStoneThermalAdapter(Map<String, dynamic>? settings) {",
              "  // No Windows, o Stone Thermal Adapter n√£o est√° dispon√≠vel",
              "  throw UnimplementedError('Stone Thermal Adapter n√£o dispon√≠vel no Windows');",
              "}",
              "",
              "/// Registry para gerenciar providers de impress√£o",
              "class PrintProviderRegistry {",
              "  static final Map<String, PrintProvider Function(Map<String, dynamic>?)> _factories = {};",
              "  static final Map<String, PrintProvider> _instances = {};",
              "  ",
              "  /// Registra um provider factory",
              "  static void registerProvider(",
              "    String key,",
              "    PrintProvider Function(Map<String, dynamic>?) factory,",
              "  ) {",
              "    _factories[key] = factory;",
              "    debugPrint('‚úÖ Print provider registrado: `$key`');",
              "  }",
              "  ",
              "  /// Obt√©m um provider pelo key",
              "  static PrintProvider? getProvider(String key, {Map<String, dynamic>? settings}) {",
              "    // Verifica se j√° existe inst√¢ncia",
              "    if (_instances.containsKey(key)) {",
              "      return _instances[key];",
              "    }",
              "    ",
              "    // Cria nova inst√¢ncia",
              "    final factory = _factories[key];",
              "    if (factory == null) {",
              "      debugPrint('‚ö†Ô∏è Print provider n√£o encontrado: `$key`');",
              "      return null;",
              "    }",
              "    ",
              "    final provider = factory(settings);",
              "    _instances[key] = provider;",
              "    return provider;",
              "  }",
              "  ",
              "  /// Registra todos os providers dispon√≠veis baseado na configura√ß√£o",
              "  static Future<void> registerAll(PrintConfig config) async {",
              "    // PDF sempre dispon√≠vel",
              "    registerProvider('pdf', (_) => PDFPrinterAdapter());",
              "    ",
              "    if (config.canUseProvider('stone_thermal')) {",
              "      // No Windows, o Stone Thermal n√£o est√° dispon√≠vel",
              "      debugPrint('‚ÑπÔ∏è Stone Thermal Adapter n√£o registrado (n√£o dispon√≠vel no Windows)');",
              "    }",
              "    ",
              "    if (config.canUseProvider('elgin_thermal')) {",
              "      registerProvider('elgin_thermal', (settings) {",
              "        return ElginThermalAdapter(settings: settings);",
              "      });",
              "    }",
              "    ",
              "    debugPrint('üì¶ Total de print providers registrados: `${_factories.length}`');",
              "  }",
              "  ",
              "  /// Lista todos os providers registrados",
              "  static List<String> getRegisteredProviders() {",
              "    return _factories.keys.toList();",
              "  }",
              "  ",
              "  /// Limpa inst√¢ncias (√∫til para testes)",
              "  static void clear() {",
              "    _instances.clear();",
              "  }",
              "}"
            )
            Set-Content -Path $printRegistryPath -Value ($stubLines -join "`r`n")
            Write-Host "   ‚úÖ Stub criado: $printRegistryPath (import do loader removido)"
          }
          
          Write-Host ""
          Write-Host "‚úÖ Prepara√ß√£o conclu√≠da"
          Write-Host "   O pacote stone_payments N√ÉO ser√° inclu√≠do no build do Windows"

      - name: Clean Flutter build cache
        run: flutter clean
      
      - name: Install dependencies
        run: flutter pub get

      - name: Verify Flutter setup
        run: flutter doctor -v

      - name: Build Windows
        run: |
          $flavor = "$env:FLAVOR"
          $buildMode = "$env:BUILD_MODE"
          $buildType = "$env:BUILD_TYPE"
          
          if ([string]::IsNullOrWhiteSpace($flavor) -or $flavor -eq '') {
            $flavor = "mobile"
          }
          
          Write-Host "=========================================="
          Write-Host "BUILD CONFIGURATION"
          Write-Host "Branch: ${{ github.ref }}"
          Write-Host "Flavor: $flavor"
          Write-Host "Build Mode: $buildMode"
          Write-Host "Build Type: $buildType"
          Write-Host "=========================================="
          
          if ($buildMode -eq "release") {
            Write-Host "Building in RELEASE mode (main branch)"
          flutter build windows --release --dart-define=FLAVOR=$flavor
          } else {
            Write-Host "Building in DEBUG mode (develop branch)"
            flutter build windows --debug --dart-define=FLAVOR=$flavor
          }
        continue-on-error: false

      - name: Verify stone_payments was removed
        run: |
          Write-Host "=========================================="
          Write-Host "VERIFYING STONE_PAYMENTS REMOVAL"
          Write-Host "=========================================="
          
          # Verifica se stone_payments foi removido do pubspec.yaml
          $pubspecContent = Get-Content pubspec.yaml -Raw
          if ($pubspecContent -match 'stone_payments') {
            Write-Host "‚ùå ERRO: stone_payments ainda est√° no pubspec.yaml!"
            Write-Host "   O build pode falhar ou incluir o SDK Stone"
            exit 1
          } else {
            Write-Host "‚úÖ stone_payments n√£o encontrado no pubspec.yaml"
          }
          
          # Verifica se os stubs foram criados
          $stubPaths = @(
            "lib/data/adapters/payment/providers/stone_pos_adapter.dart",
            "lib/data/adapters/printing/providers/stone_thermal_adapter.dart",
            "lib/data/adapters/printing/providers/stone_thermal_adapter_loader.dart",
            "lib/data/adapters/payment/providers/mappers/stone_transaction_mapper.dart",
            "lib/data/adapters/printing/print_provider_registry.dart"
          )
          
          foreach ($stubPath in $stubPaths) {
            if (Test-Path $stubPath) {
              $stubContent = Get-Content $stubPath -Raw
              if ($stubContent -match 'STUB') {
                Write-Host "‚úÖ Stub criado corretamente: $stubPath"
              } else {
                Write-Host "‚ö†Ô∏è $stubPath existe mas n√£o parece ser um stub"
              }
            } else {
              Write-Host "‚ö†Ô∏è $stubPath n√£o encontrado"
            }
          }
          
          Write-Host ""
          Write-Host "‚úÖ Verifica√ß√£o conclu√≠da"
          Write-Host "   O pacote stone_payments N√ÉO ser√° inclu√≠do no execut√°vel Windows"

      - name: Create ZIP artifact
        run: |
          $versionLine = Get-Content pubspec.yaml | Select-String 'version:'
          $version = ($versionLine.Line -split ':')[1].Trim()
          $flavor = "$env:FLAVOR"
          $buildMode = "$env:BUILD_MODE"
          $buildType = "$env:BUILD_TYPE"
          
          if ([string]::IsNullOrWhiteSpace($flavor) -or $flavor -eq '') {
            $flavor = "mobile"
          }
          
          $zipName = "mx_cloud_pdv_windows_${flavor}_${buildMode}_${version}.zip"
          
          Write-Host "=========================================="
          Write-Host "CREATING ZIP ARTIFACT"
          Write-Host "Build Type: $buildType"
          Write-Host "Source Path: build\windows\x64\runner\$buildType\*"
          Write-Host "ZIP Name: $zipName"
          Write-Host "=========================================="
          
          # Verificar se o diret√≥rio existe
          $sourcePath = "build\windows\x64\runner\$buildType"
          if (-not (Test-Path $sourcePath)) {
            Write-Host "ERROR: Build directory does not exist: $sourcePath"
            Write-Host "Available directories:"
            Get-ChildItem "build\windows\x64\runner\" -Directory | ForEach-Object { Write-Host "  - $($_.Name)" }
            exit 1
          }
          
          Write-Host "Creating ZIP from: $sourcePath"
          Compress-Archive -Path "$sourcePath\*" -DestinationPath $zipName -Force
          
          Write-Host "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          if (Test-Path $zipName) {
            Write-Host "ZIP created successfully: $zipName"
            Get-Item $zipName | Select-Object Name, Length
          } else {
            Write-Host "ERROR: ZIP file was not created!"
            exit 1
          }

      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ env.FLAVOR }}-${{ env.BUILD_MODE }}
          path: |
            build/windows/x64/runner/${{ env.BUILD_TYPE }}/**
            *.zip
          retention-days: 30
          if-no-files-found: error

      - name: Create Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

