name: Build Windows

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Flavor to build (mobile ou stoneP2)'
        required: false
        default: 'mobile'
        type: choice
        options:
          - mobile
          - stoneP2

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    env:
      FLAVOR: ${{ github.event.inputs.flavor || 'mobile' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix package name in pubspec.yaml (CRITICAL - before any Flutter command)
        run: |
          # IMPORTANTE: O Flutter pode inferir o nome do pacote do diretório 'h4nd-pdv' (com hífen)
          # antes de ler o pubspec.yaml. Precisamos garantir que o pubspec.yaml tenha o nome correto
          # ANTES de qualquer comando do Flutter ser executado.
          Write-Host "=========================================="
          Write-Host "FIXING PACKAGE NAME IN pubspec.yaml"
          Write-Host "Repository name: h4nd-pdv (invalid for Dart package)"
          Write-Host "Correct package name: mx_cloud_pdv"
          Write-Host "=========================================="
          
          # Ler o nome atual
          $currentName = (Get-Content pubspec.yaml | Select-String '^name:\s*(.+)$').Matches.Groups[1].Value.Trim()
          Write-Host "Current package name in pubspec.yaml: $currentName"
          
          # Sempre garantir que o nome está correto (mesmo que já esteja)
          if ($currentName -ne 'mx_cloud_pdv') {
            Write-Host "Fixing package name from '$currentName' to 'mx_cloud_pdv'"
            (Get-Content pubspec.yaml) -replace '^name:\s*.+$', 'name: mx_cloud_pdv' | Set-Content pubspec.yaml
          }
          
          # Verificar novamente
          $verifyName = (Get-Content pubspec.yaml | Select-String '^name:\s*(.+)$').Matches.Groups[1].Value.Trim()
          Write-Host "Verified package name: $verifyName"
          
          if ($verifyName -ne 'mx_cloud_pdv') {
            Write-Host "ERROR: Failed to set correct package name!"
            exit 1
          }
          
          if ($verifyName -notmatch '^[a-z0-9_]+$') {
            Write-Host "ERROR: Invalid package name format: $verifyName"
            Write-Host "Package name must be lowercase with underscores only (e.g., mx_cloud_pdv)"
            exit 1
          }
          
          Write-Host "✓ Package name is correct: $verifyName"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Create Windows platform files (if needed)
        run: |
          # O pubspec.yaml já foi corrigido no passo anterior
          # Verificar novamente por segurança
          $packageName = (Get-Content pubspec.yaml | Select-String '^name:\s*(.+)$').Matches.Groups[1].Value.Trim()
          Write-Host "Package name in pubspec.yaml: $packageName"
          if ($packageName -ne 'mx_cloud_pdv') {
            Write-Host "ERROR: Package name is incorrect! Expected 'mx_cloud_pdv', got: $packageName"
            Write-Host "This should have been fixed in the previous step."
            exit 1
          }
          
          # Verificar se a plataforma Windows já existe na raiz (não em android/)
          if (Test-Path "windows") {
            Write-Host "Windows platform already exists in root, skipping flutter create"
          } else {
            Write-Host "Creating Windows platform..."
            Write-Host "NOTE: Flutter may validate package name based on directory name 'h4nd-pdv'"
            Write-Host "This is a known issue when the repository name contains hyphens."
            Write-Host "We'll attempt to create the platform, but if it fails, we'll use a workaround."
            
            # O Flutter pode estar validando o nome do pacote baseado no diretório
            # Vamos garantir que o pubspec.yaml está correto e fazer pub get primeiro
            flutter pub get
            
            # Tentar criar a plataforma Windows com tratamento de erro robusto
            $ErrorActionPreference = 'Continue'
            $createOutput = @()
            $createExitCode = 0
            
            try {
              flutter create --platforms=windows . 2>&1 | ForEach-Object {
                $createOutput += $_
                Write-Host $_
              }
              $createExitCode = $LASTEXITCODE
            } catch {
              $createOutput += $_.Exception.Message
              Write-Host "Exception caught: $($_.Exception.Message)"
              $createExitCode = 1
            }
            
            # Verificar se houve erro relacionado ao nome do pacote
            $hasPackageNameError = $false
            $createOutput | ForEach-Object {
              if ($_ -match "is not a valid Dart package name" -or $_ -match "h4nd-pdv") {
                $hasPackageNameError = $true
                Write-Host "ERROR DETECTED: $_"
              }
            }
            
            if ($hasPackageNameError -or $createExitCode -ne 0) {
              Write-Host "=========================================="
              Write-Host "ERROR: flutter create failed"
              Write-Host "=========================================="
              Write-Host "Full output:"
              $createOutput | ForEach-Object { Write-Host $_ }
              
              # Verificar se o problema é realmente o nome do pacote
              $nameCheck = (Get-Content pubspec.yaml | Select-String '^name:\s*(.+)$').Matches.Groups[1].Value.Trim()
              Write-Host "Package name in pubspec.yaml: $nameCheck"
              
              if ($nameCheck -eq 'mx_cloud_pdv') {
                Write-Host "=========================================="
                Write-Host "WORKAROUND: Flutter is using directory name 'h4nd-pdv' instead of package name"
                Write-Host "Solution: Skip flutter create and use existing windows/ directory if available"
                Write-Host "=========================================="
                
                # Verificar se há um diretório windows em android/ que podemos copiar
                if (Test-Path "android\windows") {
                  Write-Host "Found android\windows directory. Copying to root..."
                  Copy-Item -Path "android\windows" -Destination "windows" -Recurse -Force
                  
                  # Verificar se a cópia foi bem-sucedida
                  if (Test-Path "windows") {
                    Write-Host "✓ Windows platform copied successfully from android\windows"
                    Write-Host "Continuing with build process..."
                    # Não falhar o build, o workaround funcionou
                  } else {
                    Write-Host "ERROR: Failed to copy android\windows to windows\"
                    exit 1
                  }
                } elseif (-not (Test-Path "windows")) {
                  Write-Host "ERROR: Windows platform does not exist and cannot be created."
                  Write-Host "The Flutter tool is rejecting the directory name 'h4nd-pdv'."
                  Write-Host "Permanent solution: Rename the repository from 'h4nd-pdv' to 'h4nd_pdv' or 'mx_cloud_pdv'"
                  Write-Host "Temporary workaround: Create the windows/ directory structure manually"
                  exit 1
                } else {
                  Write-Host "✓ Windows platform already exists, continuing..."
                }
              } else {
                Write-Host "Fixing package name and retrying..."
                (Get-Content pubspec.yaml) -replace '^name:\s*.+$', 'name: mx_cloud_pdv' | Set-Content pubspec.yaml
                flutter create --platforms=windows .
              }
            } else {
              Write-Host "✓ flutter create completed successfully"
            }
            
            # Verificação final: se o diretório windows/ existe, o step foi bem-sucedido
            if (Test-Path "windows") {
              Write-Host "=========================================="
              Write-Host "✓ SUCCESS: Windows platform is ready"
              Write-Host "=========================================="
            } else {
              Write-Host "=========================================="
              Write-Host "ERROR: Windows platform directory does not exist"
              Write-Host "=========================================="
              exit 1
            }
          }

      - name: Verify package name after platform creation
        run: |
          $packageName = (Get-Content pubspec.yaml | Select-String '^name:\s*(.+)$').Matches.Groups[1].Value.Trim()
          Write-Host "Package name after platform creation: $packageName"
          if ($packageName -ne 'mx_cloud_pdv') {
            Write-Host "ERROR: Package name was changed! Expected 'mx_cloud_pdv', got: $packageName"
            Write-Host "Restoring correct package name..."
            (Get-Content pubspec.yaml) -replace '^name:\s*.+$', 'name: mx_cloud_pdv' | Set-Content pubspec.yaml
            Write-Host "Package name restored to: mx_cloud_pdv"
            # Verificar novamente
            $verifyName = (Get-Content pubspec.yaml | Select-String '^name:\s*(.+)$').Matches.Groups[1].Value.Trim()
            Write-Host "Verified package name: $verifyName"
          }

      - name: Install dependencies
        run: |
          # Garantir que o nome do pacote está correto antes de pub get
          $packageName = (Get-Content pubspec.yaml | Select-String '^name:\s*(.+)$').Matches.Groups[1].Value.Trim()
          if ($packageName -ne 'mx_cloud_pdv') {
            Write-Host "Fixing package name before pub get: $packageName -> mx_cloud_pdv"
            (Get-Content pubspec.yaml) -replace '^name:\s*.+$', 'name: mx_cloud_pdv' | Set-Content pubspec.yaml
          }
          flutter pub get

      - name: Verify Flutter setup
        run: flutter doctor -v
      
      - name: Final package name verification
        run: |
          $packageName = (Get-Content pubspec.yaml | Select-String '^name:\s*(.+)$').Matches.Groups[1].Value.Trim()
          Write-Host "Final package name verification: $packageName"
          if ($packageName -ne 'mx_cloud_pdv') {
            Write-Host "ERROR: Package name is incorrect: $packageName (expected: mx_cloud_pdv)"
            exit 1
          }
          Write-Host "✓ Package name is correct: $packageName"

      - name: Build Windows (Release)
        run: |
          $flavor = "$env:FLAVOR"
          if ([string]::IsNullOrWhiteSpace($flavor) -or $flavor -eq '') {
            $flavor = "mobile"
          }
          Write-Host "Building with flavor: $flavor"
          flutter build windows --release --dart-define=FLAVOR=$flavor
        continue-on-error: false

      - name: Create ZIP artifact
        run: |
          $versionLine = Get-Content pubspec.yaml | Select-String 'version:'
          $version = ($versionLine.Line -split ':')[1].Trim()
          $flavor = "$env:FLAVOR"
          if ([string]::IsNullOrWhiteSpace($flavor) -or $flavor -eq '') {
            $flavor = "mobile"
          }
          $zipName = "mx_cloud_pdv_windows_${flavor}_${version}.zip"
          
          Write-Host "Creating ZIP: $zipName"
          Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath $zipName -Force
          
          Write-Host "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          if (Test-Path $zipName) {
            Write-Host "ZIP created successfully: $zipName"
            Get-Item $zipName | Select-Object Name, Length
          } else {
            Write-Host "ERROR: ZIP file was not created!"
            exit 1
          }

      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ env.FLAVOR }}
          path: |
            build/windows/x64/runner/Release/**
            *.zip
          retention-days: 30
          if-no-files-found: error

      - name: Create Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

